/**
 * Request ID Plugin for Fastify
 * Auto-generated by bffgen
 * 
 * Generates unique ID for each request to track across logs
 */

const fp = require('fastify-plugin');
const crypto = require('crypto');

/**
 * Generate unique request ID
 */
function generateRequestId() {
  return crypto.randomBytes(16).toString('hex');
}

/**
 * Request ID plugin
 */
async function requestIdPlugin(fastify, options) {
  fastify.addHook('onRequest', async (request, reply) => {
    // Check if request ID already exists (from load balancer or proxy)
    const existingId = request.headers['x-request-id'] || 
                       request.headers['x-correlation-id'] ||
                       request.headers['x-trace-id'];
    
    // Use existing ID or generate new one
    request.id = existingId || generateRequestId();
    
    // Add request ID to response headers
    reply.header('X-Request-ID', request.id);
    
    // Add request ID to logger context
    request.log = request.log.child({ requestId: request.id });
  });
}

module.exports = fp(requestIdPlugin, {
  name: 'request-id-plugin'
});

